---
- name: Deploy ERP Application on AWS EC2
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    region: us-east-1
    instance_type: t2.medium
    ami_id: ami-0447a12f28fddb066     # Example: Ubuntu 22.04 LTS (update as needed)
    key_name: my-keypair
    security_group: my-erp-sg
    erp_setup_script: /path/to/your-erp-install-script.sh

  tasks:
    - name: Launch EC2 instance
      community.aws.ec2_instance:
        key_name: "{{ key_name }}"
        name: "ERP-Server"
        vpc_subnet_id: subnet-xxxxxx      # Set your subnet
        instance_type: "{{ instance_type }}"
        image_id: "{{ ami_id }}"
        region: "{{ region }}"
        security_group: "{{ security_group }}"
        network:
          assign_public_ip: true
        tags:
          Environment: production
          Application: ERP
        wait: yes
      register: ec2

    - name: Wait for SSH to come up
      ansible.builtin.wait_for:
        host: "{{ ec2.instances[0].public_ip_address }}"
        port: 22
        timeout: 300

    - name: Add new instance to host group
      add_host:
        hostname: "{{ ec2.instances[0].public_ip_address }}"
        groupname: launched

    - name: Install ERP application
      hosts: launched
      become: true
      gather_facts: yes
      tasks:
        - name: Copy ERP setup script to server
          ansible.builtin.copy:
            src: "{{ erp_setup_script }}"
            dest: /tmp/erp-setup.sh
            mode: '0700'
        - name: Run ERP setup script
          ansible.builtin.shell: /tmp/erp-setup.sh
